---
name: Renovate third-party licenses

on:
  push:
    branches:
    - renovate/**

permissions:
  contents: read

jobs:
  refresh-third-party-licenses:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        persist-credentials: false
    - name: Install uv
      uses: astral-sh/setup-uv@v6
    - name: Set up Python
      run: uv python install
    - name: Configure SSH for deploy key
      env:
        GITHUBACTIONS_DEPLOY_KEY: ${{ secrets.GITHUBACTIONS_DEPLOY_KEY }}
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        printf '%s\n' "$GITHUBACTIONS_DEPLOY_KEY" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
        cat > ~/.ssh/config <<'EOF'
        Host github.com
          IdentityFile ~/.ssh/id_ed25519
          IdentitiesOnly yes
          StrictHostKeyChecking yes
        EOF
        chmod 600 ~/.ssh/config
        git remote set-url origin git@github.com:${{ github.repository }}.git
    - name: Regenerate THIRD_PARTY_LICENSES.md
      run: ./.tools/show-third-party-licenses.sh > THIRD_PARTY_LICENSES.md
    - name: Commit updated THIRD_PARTY_LICENSES.md
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        if git diff --quiet -- THIRD_PARTY_LICENSES.md; then
          echo "No THIRD_PARTY_LICENSES.md changes to commit."
          exit 0
        fi

        git add THIRD_PARTY_LICENSES.md
        git commit -m "chore: refresh THIRD_PARTY_LICENSES.md"
        git push
